#!/usr/bin/env bash

# mfa - Yubikey 2FA code generator

set -euo pipefail

source "$HOME/.config/utils/common.sh"

# check for Yubikey presence
function check_yubikey() {
    if ! ykman list | grep -q .; then
        log_error "No Yubikey found. Please connect your Yubikey and try again."
        exit 1
    fi
}

# detect the operating system and set the copy command
function set_copy_command() {
    case "$(uname -s)" in
        Linux*) COPY='xclip -selection clipboard';;
        Darwin*) COPY='pbcopy';;
        *) log_error "Unrecognized operating system."
    esac
}

# generate and optionally copy the 2FA code
function generate_code() {
    local account="${1:-}"
    if [ -z "$account" ]; then
        log_info "Listing available accounts and generating codes..."
        ykman oath accounts code
    else
        log_info "Generating 2FA code for account: $1"
        ykman oath accounts code "$1" | tee /dev/tty | awk -F' ' '{print $2}' | tr -d '\n' | ${COPY}
        log_info "Code copied to clipboard."
    fi
}

check_yubikey
set_copy_command

if [ $# -eq 0 ]; then
    generate_code
else
    generate_code "$1"
fi
